# Repository Guidelines

## Project Structure & Module Organization
- `run.py` is the single entry point; it loads YAML configs from `configs/` and routes to stage functions in `src/nbglm/pipelines.py`.
- Core modules live under `src/nbglm/`: `model.py`, `data_io.py`, `dataset.py`, `eval.py`, and `utils.py`. Extend the relevant file instead of duplicating logic.
- Temporary artifacts belong in timestamped directories under `outputs/`; remove them once reviewed. Tests mirror the source tree under `tests/` with matching module paths.

## Build, Test, and Development Commands
- `python -m venv .venv && source .venv/bin/activate` — create and activate a clean virtual environment.
- `pip install torch scanpy anndata numpy pandas tqdm pyyaml` — install required dependencies.
- `python run.py --config configs/default.yaml` — execute the default pipeline; adjust configs with `--set key=value` overrides as needed.

## Coding Style & Naming Conventions
- Use 4-space indentation and keep code Black-compatible; add succinct type hints for new functions and public APIs.
- Prefer snake_case for variables, functions, and config keys; reserve PascalCase for classes.
- Keep docstrings to a single English sentence; add comments only when clarifying tensor shapes or non-obvious math.

## Testing Guidelines
- Run targeted suites with `python -m pytest` after mirroring new modules under `tests/`.
- Validate evaluation-only changes via `python run.py --set pipeline.mode=evaluate_only --set paths.pred_h5ad=...`.
- Name tests after the behavior under scrutiny (e.g., `test_dataset_filters_inputs`).

## Commit & Pull Request Guidelines
- Write commit subjects in present tense under 60 characters (e.g., `Adjust sampler batching`).
- Summarize motivation, solution, and reproduction commands in the body; include metric snapshots from `outputs/.../logs/run.log` when relevant.
- For PRs, outline affected pipeline stages, link issues, and note any follow-up tasks.

## Security & Configuration Tips
- Parameterize sensitive paths through environment variables referenced in YAML configs.
- Do not commit artifacts generated by `tools/precompute_true_de_cache.py`; document regeneration steps instead.
